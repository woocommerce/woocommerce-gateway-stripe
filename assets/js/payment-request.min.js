!function(e){var t={init:function(){var t=this;t.hasPaymentRequestSupport()&&e(document.body).on("click",".cart_totals a.checkout-button",t.initPaymentRequest)},hasPaymentRequestSupport:function(){return window.PaymentRequest&&"https:"===window.location.protocol},getSupportedNetworks:function(){return["amex","diners","discover","jcb","mastercard","visa"]},getAjaxURL:function(e){return wcStripePaymentRequestParams.ajax_url.toString().replace("%%endpoint%%","wc_stripe_"+e)},initPaymentRequest:function(i){i.preventDefault();var n=t,s={security:wcStripePaymentRequestParams.nonce.payment};e.ajax({type:"POST",data:s,url:n.getAjaxURL("get_cart_details"),success:function(e){n.openPaymentRequest(e)}})},openPaymentRequest:function(t){var i=this,n=[{supportedMethods:["basic-card"],data:{supportedNetworks:i.getSupportedNetworks()}}],s={requestPayerPhone:!0,requestPayerEmail:!0};t.shipping_required&&(s.requestShipping=!0);var a=t.order_data,r=new PaymentRequest(n,a,s);r.addEventListener("shippingaddresschange",function(e){e.updateWith(new Promise(function(e,t){i.updateShippingOptions(a,r.shippingAddress,e,t)}))}),r.addEventListener("shippingoptionchange",function(e){e.updateWith(new Promise(function(e,t){i.updateShippingDetails(a,r.shippingOption,e,t)}))}),r.canMakePayment?r.show().then(function(e){i.processPayment(e)}).catch(function(t){console.error(t),e.blockUI({message:null,overlayCSS:{background:"#fff",opacity:.6}}),window.location.href=wcStripePaymentRequestParams.checkout_url}):window.location.href=wcStripePaymentRequestParams.checkout_url},updateShippingOptions:function(t,i,n,s){var a=this,r={security:wcStripePaymentRequestParams.nonce.shipping,country:i.country,state:i.region,postcode:i.postalCode,city:i.city,address:void 0===i.addressLine[0]?"":i.addressLine[0],address_2:void 0===i.addressLine[1]?"":i.addressLine[1]};e.ajax({type:"POST",data:r,url:a.getAjaxURL("get_shipping_options"),success:function(e){t.shippingOptions=e,1==t.shippingOptions.length?a.updateShippingDetails(t,t.shippingOptions[0].id,n,s):n(t)}})},updateShippingDetails:function(t,i,n,s){var a=this,r=null,o={security:wcStripePaymentRequestParams.nonce.update_shipping,shipping_method:[i]};e.ajax({type:"POST",data:o,url:a.getAjaxURL("update_shipping_method"),success:function(e){t.shippingOptions.forEach(function(n,s){n.id===i?(r=s,n.selected=!0,t.total.amount.value=parseFloat(e.total),e.items&&(t.displayItems=e.items)):n.selected=!1}),null===r&&s(wcStripePaymentRequestParams.i18n.unknown_shipping.toString().replace("[option]",i)),n(t)}})},getOrderData:function(e){var t=e.details.billingAddress,i=e.shippingAddress,n={_wpnonce:wcStripePaymentRequestParams.nonce.checkout,billing_first_name:t.recipient.split(" ").slice(0,1).join(" "),billing_last_name:t.recipient.split(" ").slice(1).join(" "),billing_company:t.organization,billing_email:e.payerEmail,billing_phone:e.payerPhone,billing_country:t.country,billing_address_1:void 0===t.addressLine[0]?"":t.addressLine[0],billing_address_2:void 0===t.addressLine[1]?"":t.addressLine[1],billing_city:t.city,billing_state:t.region,billing_postcode:t.postalCode,shipping_first_name:"",shipping_last_name:"",shipping_company:"",shipping_country:"",shipping_address_1:"",shipping_address_2:"",shipping_city:"",shipping_state:"",shipping_postcode:"",shipping_method:[e.shippingOption],order_comments:"",payment_method:"stripe",stripe_token:""};return i&&(n.shipping_first_name=i.recipient.split(" ").slice(0,1).join(" "),n.shipping_last_name=i.recipient.split(" ").slice(1).join(" "),n.shipping_company=i.organization,n.shipping_country=i.country,n.shipping_address_1=void 0===i.addressLine[0]?"":i.addressLine[0],n.shipping_address_2=void 0===i.addressLine[1]?"":i.addressLine[1],n.shipping_city=i.city,n.shipping_state=i.region,n.shipping_postcode=i.postalCode),n},getCardData:function(e){var t=e.details.billingAddress;return{number:e.details.cardNumber,cvc:e.details.cardSecurityCode,exp_month:parseInt(e.details.expiryMonth,10)||0,exp_year:parseInt(e.details.expiryYear,10)||0,name:t.recipient,address_line1:void 0===t.addressLine[0]?"":t.addressLine[0],address_line2:void 0===t.addressLine[1]?"":t.addressLine[1],address_state:t.region,address_city:t.city,address_zip:t.postalCode,address_country:t.country}},getErrorMessageHTML:function(t){return e('<div class="woocommerce-error" />').text(t)},abortPayment:function(t,i){t.complete("fail").then(function(){var t=e(".shop_table.cart").closest("form");e(".woocommerce-error").remove(),t.before(i),e("html, body").animate({scrollTop:t.prev(".woocommerce-error").offset().top},600)}).catch(function(e){console.error(e)})},completePayment:function(e,t){e.complete("success").then(function(){window.location=t}).catch(function(e){console.error(e)})},processPayment:function(t){var i=this,n=i.getOrderData(t),s=i.getCardData(t);Stripe.setPublishableKey(wcStripePaymentRequestParams.stripe.key),Stripe.createToken(s,function(s,a){a.error?i.abortPayment(t,i.getErrorMessageHTML(a.error.message)):"no"===wcStripePaymentRequestParams.stripe.allow_prepaid_card&&"prepaid"===a.card.funding?i.abortPayment(t,i.getErrorMessageHTML(wcStripePaymentRequestParams.i18n.no_prepaid_card)):(n.stripe_token=a.id,e.ajax({type:"POST",data:n,dataType:"json",url:i.getAjaxURL("create_order"),success:function(e){"success"===e.result?i.completePayment(t,e.redirect):i.abortPayment(t,e.messages)},complete:function(e,t){"success"!==t&&console.error(e)}}))})}};t.init()}(jQuery);